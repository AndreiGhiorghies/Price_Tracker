<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Price Tracker — Produse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4">Price Tracker</h1>
      <div>
        <form action="{{ url_for('trigger_scrape') }}" method="post" style="display:inline" class="d-flex align-items-center gap-2">
          <input type="text" name="query" class="form-control form-control-sm" placeholder="Query scrape..." style="width: 200px;" value="">
          <button class="btn btn-sm btn-outline-primary">Start scrape</button>
        </form>
        <a class="btn btn-sm btn-success ms-2" href="{{ url_for('export_csv') }}">Export CSV</a>
      </div>
    </div>

    <form id="bulk-delete-form" action="{{ url_for('bulk_delete_products') }}" method="post" onsubmit="return confirm('Sigur vrei să ștergi produsele selectate?');" class="mb-2">
      <button type="submit" class="btn btn-danger btn-sm" id="bulk-delete-btn" disabled>Șterge selectate</button>
    </form>

  <form class="row g-2 mb-3" method="get">
    <div class="col-md-5">
      <input name="q" value="{{ q }}" class="form-control" placeholder="Cauta titlu...">
    </div>
    <div class="col-md-3">
      <input name="site" value="{{ site_filter }}" class="form-control" placeholder="Site (ex: emag)">
    </div>
    <div class="col-md-2">
      <select name="per_page" class="form-select">
        <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary">Filtrează</button>
    </div>
  </form>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th>#</th>
            <th>Site</th>
            <th>Titlu</th>
            <th>Preț</th>
            <th>Rating</th>
            <th>Ultima</th>
          </tr>
        </thead>
        <tbody>
        {% if products %}
          {% for p in products %}
            <tr>
              <td><input type="checkbox" class="select-product" name="product_ids" value="{{ p.id }}" form="bulk-delete-form"></td>
              <td>{{ loop.index + (page-1)*per_page }}</td>
              <td><code>{{ p.site_name }}</code></td>
              <td><a href="{{ url_for('product_detail', product_id=p.id) }}">{{ p.title }}</a></td>
              <td>{{ p.currency or '' }} {{ (p.last_price) if p.last_price is not none else '-' }}</td>
              <td>{{ p.rating or '-' }} {% if p.ratings_count %}({{ p.ratings_count }}){% endif %}</td>
              <td class="text-muted">{{ p.last_seen_at }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="7" class="text-center py-4">Niciun produs</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center">
      <div>Total: {{ total }}</div>
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item {% if page<=1 %}disabled{% endif %}"><a class="page-link" href="?q={{ q }}&site={{ site_filter }}&per_page={{ per_page }}&page={{ page-1 }}">Prev</a></li>
          <li class="page-item disabled"><span class="page-link">{{ page }} / {{ total_pages }}</span></li>
          <li class="page-item {% if page>=total_pages %}disabled{% endif %}"><a class="page-link" href="?q={{ q }}&site={{ site_filter }}&per_page={{ per_page }}&page={{ page+1 }}">Next</a></li>
        </ul>
      </nav>
    </div>
  </div>
</div>
</tbody>
</table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Select/deselect all checkboxes
document.getElementById('select-all').addEventListener('change', function() {
  const checked = this.checked;
  document.querySelectorAll('.select-product').forEach(cb => { cb.checked = checked; });
  document.getElementById('bulk-delete-btn').disabled = !checked && !Array.from(document.querySelectorAll('.select-product')).some(cb => cb.checked);
});
// Enable/disable bulk delete button
document.querySelectorAll('.select-product').forEach(cb => {
  cb.addEventListener('change', function() {
    document.getElementById('bulk-delete-btn').disabled = !Array.from(document.querySelectorAll('.select-product')).some(cb => cb.checked);
    // If all are checked, check select-all
    document.getElementById('select-all').checked = Array.from(document.querySelectorAll('.select-product')).every(cb => cb.checked);
  });
});
</script>
</body>
</html>
