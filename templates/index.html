<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tracker — Produse</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --secondary: #64748b;
            --light: #f8fafc;
            --dark: #0f172a;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Styles */
        .header {
            background: rgba(255, 255, 255, 0.95);
            /* backdrop-filter: blur(10px); */
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: flex-start;
        }

        .scrape-form {
            display: flex;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .scrape-input {
            border: none;
            outline: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            width: 200px;
            background: transparent;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        /* Filters Section */
        .filters {
            background: rgba(255, 255, 255, 0.9);
            /* backdrop-filter: blur(10px); */
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 0.5rem; /* redus spațiul */
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.875rem;
        }

        .form-input, .form-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Bulk Actions */
        .bulk-actions {
            margin-bottom: 0; /* implicit fără spațiu */
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .bulk-actions.active {
            opacity: 1;
            transform: translateY(0);
            margin-bottom: 1rem; /* spațiu când e activ */
            margin-top: 1rem;
            pointer-events: auto;
        }

        /* Table Card */
        .table-card {
            background: rgba(255, 255, 255, 0.95);
            /* backdrop-filter: blur(10px); */
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .table thead {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.001);
        }

        .product-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .product-link:hover {
            color: var(--primary);
        }

        .site-badge {
            background: var(--gradient);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .price {
            font-weight: 700;
            color: var(--success);
            font-size: 1.1rem;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stars {
            color: var(--warning);
        }

        .checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        /* Footer */
        .table-footer {
            padding: 1.5rem;
            background: rgba(248, 250, 252, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border);
        }

        .pagination {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            text-decoration: none;
            color: var(--secondary);
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(.disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            background: var(--gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .table-card {
                overflow-x: auto;
            }

            .table {
                min-width: 600px;
            }

            .table-footer {
                flex-direction: column;
                gap: 1rem;
            }

            .filters {
                margin-bottom: 0.5rem;
            }

            .bulk-actions.active {
                margin-bottom: 0.5rem;
            }
        }

        /* Loading Animation */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            /* backdrop-filter: blur(10px); */
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .table-header-btn {
            background: none;
            border: none;
            color: var(--dark);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
            outline: none;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25em;
            position: relative;
            justify-content: flex-start;
            width: 100%;
            text-align: left;
        }
        .table-header-arrow-placeholder {
            display: inline-block;
            width: 1.2em;
            min-width: 1.2em;
            height: 1em;
            vertical-align: middle;
            margin-left: 0.2em;
            /* always visible except when active */
            visibility: visible;
            background: transparent;
            transition: width 0.2s;
        }
        .table-header-btn.active .table-header-arrow-placeholder {
            width: 0;
            min-width: 0;
            margin-left: 0;
            visibility: hidden;
        }
        .table-header-arrow {
            display: inline-block;
            width: 1.2em;
            min-width: 1.2em;
            height: 1em;
            vertical-align: middle;
            margin-right: 0.2em;
            color: var(--primary);
            visibility: visible;
            background: transparent;
            position: static;
        }
        .table-header-btn span.header-text {
            margin-left: 0;
            transition: none;
            display: inline-block;
            text-align: left;
        }
        .table-header-btn.active,
        .table-header-btn:hover,
        .table-header-btn:focus {
            color: var(--primary);
        }
        .export-dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 110%;
            left: 0;
            min-width: 140px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 100;
            padding: 0.5em 0;
        }
        .dropdown-item {
            width: 100%;
            background: none;
            border: none;
            padding: 0.7em 1em;
            text-align: left;
            font-size: 1em;
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5em;
            transition: background 0.2s;
        }
        .dropdown-item:hover {
            background: var(--light);
            color: var(--primary);
        }
        .export-dropdown.open .dropdown-menu {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <h1>Price Tracker</h1>
                </div>
                <div class="header-actions" style="justify-content: flex-start;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <form class="scrape-form" id="scrape-form" style="margin-right: 0.5rem;">
                            <input type="text" class="scrape-input" placeholder="Query scrape..." id="scrape-query" name="query">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-spider"></i>
                                Start scrape
                            </button>
                        </form>
                        <button type="button" id="scrape-settings-btn"
                            style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;
                                   background:white;border:1.5px solid var(--border);border-radius:8px;box-shadow:var(--shadow);
                                   cursor:pointer;padding:0;margin-left:2px;">
                            <i class="fas fa-cog" style="font-size:1.3rem;color:var(--secondary);"></i>
                        </button>
                    </div>
                    <div class="export-dropdown">
                        <button class="btn btn-success" id="export-btn" type="button">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                        <div class="dropdown-menu" id="export-dropdown-menu">
                            <button type="button" class="dropdown-item" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button type="button" class="dropdown-item" onclick="exportData('pdf')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button type="button" class="dropdown-item" onclick="exportData('xlsx')">
                                <i class="fas fa-file-excel"></i> Excel (.xlsx)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alert-success" class="alert success">
            <i class="fas fa-check-circle"></i>
            <span id="success-message"></span>
        </div>
        <div id="alert-error" class="alert error">
            <i class="fas fa-exclamation-circle"></i>
            <span id="error-message"></span>
        </div>

        <!-- Filters -->
        <div class="filters">
            <form class="filter-row" id="filter-form">
                <div class="form-group">
                    <label class="form-label">Caută titlu</label>
                    <input type="text" class="form-input" id="filter-title" name="q" placeholder="Caută în titluri..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Site</label>
                    <input type="text" class="form-input" id="filter-site" name="site" placeholder="ex: emag, altex" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Produse pe pagină</label>
                    <select class="form-select" id="per-page" name="per_page">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="filter-btn">
                        <i class="fas fa-filter"></i>
                        Filtrează
                    </button>
                </div>
            </form>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulk-actions">
            <form id="bulk-delete-form">
                <button type="submit" class="btn btn-danger" disabled id="bulk-delete-btn">
                    <i class="fas fa-trash"></i>
                    Șterge selectate (<span id="selected-count">0</span>)
                </button>
            </form>
        </div>

        <!-- Products Table -->
        <div class="table-card">
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="checkbox" id="select-all">
                        </th>
                        <th>
                            <button type="button" class="table-header-btn" data-col="id" onclick="HandleHeaderBtn('id')">
                                <span class="header-text">#</span>
                                <span class="table-header-arrow-placeholder"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="table-header-btn" data-col="site" onclick="HandleHeaderBtn('site_name')">
                                <span class="header-text">Site</span>
                                <span class="table-header-arrow-placeholder"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="table-header-btn" data-col="title"  onclick="HandleHeaderBtn('title')">
                                <span class="header-text">Titlu</span>
                                <span class="table-header-arrow-placeholder"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="table-header-btn" data-col="price" onclick="HandleHeaderBtn('last_price')">
                                <span class="header-text">Preț</span>
                                <span class="table-header-arrow-placeholder"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="table-header-btn" data-col="rating" onclick="HandleHeaderBtn('rating')">
                                <span class="header-text">Rating</span>
                                <span class="table-header-arrow-placeholder"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="table-header-btn" data-col="updated" onclick="HandleHeaderBtn('last_seen_at')">
                                <span class="header-text">Ultima actualizare</span>
                                <span class="table-header-arrow-placeholder"></span>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody id="products-table">
                </tbody>
            </table>

            <div class="table-footer">
                <div>
                    Total: <strong id="total-products">{{ total }}</strong> produse
                </div>
                <div class="pagination">
                    <!-- Paginarea va fi populată dinamic cu JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Se încarcă...</div>
    </div>

    <!-- Modal pentru setări scrape -->
    <div id="scrape-settings-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000;">
        <div style="background:white; max-width:400px; margin:40px auto; padding:2rem; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.15); position:relative;">
            <h2 style="margin-bottom:1rem;">Setări Scraping</h2>
            <form id="scrape-settings-form">
                <div style="margin-bottom:1rem;">
                    <label>Preț minim:</label>
                    <input type="number" min="0" step="1" id="scrape-min-price" name="min_price" class="form-input" style="width:100%;">
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Preț maxim:</label>
                    <input type="number" min="0" step="1" id="scrape-max-price" name="max_price" class="form-input" style="width:100%;">
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Rating minim:</label>
                    <input type="number" min="0" max="5" step="0.1" id="scrape-min-rating" name="min_rating" class="form-input" style="width:100%;">
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Număr minim rating-uri:</label>
                    <input type="number" min="0" step="1" id="scrape-min-ratings" name="min_ratings" class="form-input" style="width:100%;">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1.5rem;">
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <button type="button" id="delete-db-btn-modal"
                            style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;
                                   background:white;border:1.5px solid var(--danger);border-radius:8px;box-shadow:var(--shadow);
                                   cursor:pointer;padding:0;">
                            <i class="fas fa-trash" style="font-size:1.2rem;color:var(--danger);"></i>
                        </button>
                        <!-- Nou buton pentru configurare site -->
                        <button type="button" id="site-config-btn"
                            style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;
                                   background:white;border:1.5px solid var(--primary);border-radius:8px;box-shadow:var(--shadow);
                                   cursor:pointer;padding:0;">
                            <i class="fas fa-wrench" style="font-size:1.2rem;color:var(--primary);"></i>
                        </button>
                    </div>
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <button type="button" class="btn btn-secondary" id="scrape-settings-cancel">Anulează</button>
                        <button type="submit" class="btn btn-primary">Salvează</button>
                    </div>
                </div>
            </form>
            <button id="scrape-settings-close" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#64748b; cursor:pointer;">&times;</button>
        </div>
    </div>

    <!-- Modal confirmare ștergere DB -->
    <div id="delete-db-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000;">
        <div style="background:white; max-width:340px; margin:120px auto; padding:2rem 1.5rem; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">
            <h3 style="margin-bottom:1rem; color:var(--danger);">Ștergere bază de date</h3>
            <div style="margin-bottom:1.2rem; color:var(--secondary);">
                Sigur vrei să ștergi baza de date?<br>
                <b>Această acțiune este ireversibilă!</b>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button type="button" class="btn btn-secondary" id="delete-db-cancel">Anulează</button>
                <button type="button" class="btn btn-danger" id="delete-db-confirm">Șterge</button>
            </div>
            <button id="delete-db-close" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#64748b; cursor:pointer;">&times;</button>
        </div>
    </div>

    <!-- Modal pentru configurare site -->
    <div id="site-config-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:4000;">
        <div style="background:white; max-width:700px; width:90vw; max-height:90vh; margin:40px auto; padding:2rem; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative; overflow-y:auto;">
            <h2 style="margin-bottom:1rem;">Configurare Site</h2>
            <div id="site-list" style="margin-bottom:1.5rem; display:flex; flex-wrap:wrap; align-items:center;">
                <!-- Lista site-uri va fi populată dinamic -->
            </div>
            <div id="site-properties" style="display:none;">
                <form id="site-properties-form">
                    <!-- Inputurile pentru proprietăți vor fi generate dinamic -->
                </form>
            </div>
            <div id="site-actions-row" style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem; margin-top:1.5rem;">
                <button type="button" id="delete-site-btn"
                    style="background:white;border:1.5px solid var(--danger);border-radius:8px;color:var(--danger);font-size:1.3rem;cursor:pointer;display:none;align-items:center;justify-content:center;width:36px;height:36px;"
                    title="Șterge siteul">
                    <i class="fas fa-trash"></i>
                </button>
                <div style="display:flex; gap:0.5rem;">
                    <button type="button" class="btn btn-secondary" id="site-config-cancel">Anulează</button>
                    <button type="button" class="btn btn-primary" id="site-config-save" style="display:none;">Salvează</button>
                </div>
            </div>
            <button id="site-config-close" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#64748b; cursor:pointer;">&times;</button>
        </div>
    </div>

    <!-- Modal confirmare ștergere site -->
    <div id="delete-site-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:4100;">
        <div style="background:white; max-width:340px; margin:120px auto; padding:2rem 1.5rem; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">
            <h3 style="margin-bottom:1rem; color:var(--danger);">Ștergere site</h3>
            <div id="delete-site-modal-msg" style="margin-bottom:1.2rem; color:var(--secondary);">
                Sigur vrei să ștergi acest site?<br>
                <b>Această acțiune este ireversibilă!</b>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button type="button" class="btn btn-secondary" id="delete-site-cancel">Anulează</button>
                <button type="button" class="btn btn-danger" id="delete-site-confirm">Șterge</button>
            </div>
            <button id="delete-site-close" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#64748b; cursor:pointer;">&times;</button>
        </div>
    </div>

    <!-- Modal confirmare bulk delete produse -->
    <div id="bulk-delete-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3100;">
        <div style="background:white; max-width:340px; margin:120px auto; padding:2rem 1.5rem; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">
            <h3 style="margin-bottom:1rem; color:var(--danger);" id="bulk-delete-modal-title">Ștergere produse selectate</h3>
            <div id="bulk-delete-modal-msg" style="margin-bottom:1.2rem; color:var(--secondary);">
                <!-- Textul va fi setat dinamic -->
            </div>
            <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button type="button" class="btn btn-secondary" id="bulk-delete-cancel">Anulează</button>
                <button type="button" class="btn btn-danger" id="bulk-delete-confirm">Șterge</button>
            </div>
            <button id="bulk-delete-close" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#64748b; cursor:pointer;">&times;</button>
        </div>
    </div>

    <script>
        // Optimizare: încărcare asincronă produse, paginare, filtre, bulk delete, export CSV
        let currentPage = 1;
        let currentFilters = { q: '', site: '', per_page: 25 };
        let selectedProducts = new Set();
        let lastOrderBy = 'id', reversed = false;
        const API_BASE = 'http://127.0.0.1:8000';
        let scrapingInProgress = false;

        let scrapeSettings = {
            min_price: '',
            max_price: '',
            min_rating: '',
            min_ratings: ''
        };

        initializeScrapeSettings();

        document.addEventListener('DOMContentLoaded', async function() {
            initializeFromURL();
            initializeEventListeners();
            await loadProducts();
        });

        async function initializeScrapeSettings() {
            const formData = new FormData();
            // Trebuie să aștepți răspunsul cu await!
            const response = await fetch(`${API_BASE}/get_config`, { method: 'POST', body: formData });
            // Trebuie să faci await response.json() pentru a obține datele!
            const data = await response.json();

            scrapeSettings.min_price = data.min_price;
            scrapeSettings.max_price = data.max_price;
            scrapeSettings.min_rating = data.min_rating;
            scrapeSettings.min_ratings = data.min_ratings;
        }

        function initializeEventListeners() {
            document.getElementById('scrape-form').addEventListener('submit', handleScrape);
            document.getElementById('filter-form').addEventListener('submit', handleFilter);
            document.getElementById('bulk-delete-form').addEventListener('submit', handleBulkDelete);
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
            document.getElementById('filter-title').addEventListener('input', debounce(function(e) {
                currentFilters.q = e.target.value;
                currentPage = 1;
                loadProducts();
            }, 400));
            document.getElementById('filter-site').addEventListener('input', debounce(function(e) {
                currentFilters.site = e.target.value;
                currentPage = 1;
                loadProducts();
            }, 400));
            document.getElementById('per-page').addEventListener('change', function(e) {
                currentFilters.per_page = parseInt(e.target.value);
                currentPage = 1;
                loadProducts();
            });
            document.getElementById('scrape-settings-btn').addEventListener('click', async function() {
                document.getElementById('scrape-min-price').value = scrapeSettings.min_price || "";
                document.getElementById('scrape-max-price').value = scrapeSettings.max_price || "";
                document.getElementById('scrape-min-rating').value = scrapeSettings.min_rating || "";
                document.getElementById('scrape-min-ratings').value = scrapeSettings.min_ratings || "";
                document.getElementById('scrape-settings-modal').style.display = 'block';
            });
            document.getElementById('scrape-settings-close').onclick = function() {
                document.getElementById('scrape-settings-modal').style.display = 'none';
            };
            document.getElementById('scrape-settings-cancel').onclick = function() {
                document.getElementById('scrape-settings-modal').style.display = 'none';
            };
            document.getElementById('scrape-settings-form').onsubmit = async function(e) {
                e.preventDefault();
                scrapeSettings.min_price = document.getElementById('scrape-min-price').value;
                scrapeSettings.max_price = document.getElementById('scrape-max-price').value;
                scrapeSettings.min_rating = document.getElementById('scrape-min-rating').value;
                scrapeSettings.min_ratings = document.getElementById('scrape-min-ratings').value;
                document.getElementById('scrape-settings-modal').style.display = 'none';

                try {
                    const formData = new FormData();
                    // Trebuie să aștepți răspunsul cu await!
                    const response = await fetch(`${API_BASE}/change_config?min_price=${scrapeSettings.min_price || -1}&max_price=${scrapeSettings.max_price || -1}&min_rating=${scrapeSettings.min_rating || -1}&min_rating_number=${scrapeSettings.min_ratings || -1}`,
                                    { method: 'POST', body: formData });
                    // response.ok va fi true doar dacă răspunsul HTTP are status 2xx
                    if (!response.ok)
                        showAlert('error', 'Eroare la salvarea valorilor');
                } catch (error) {
                    console.error('Error at saving:', error);
                    showAlert('error', 'Eroare la salvarea datelor');
                }
            };
            document.getElementById('delete-db-btn-modal').addEventListener('click', function() {
                document.getElementById('delete-db-modal').style.display = 'block';
            });
            document.getElementById('delete-db-close').onclick = function() {
                document.getElementById('delete-db-modal').style.display = 'none';
            };
            document.getElementById('delete-db-cancel').onclick = function() {
                document.getElementById('delete-db-modal').style.display = 'none';
            };
            document.getElementById('delete-db-confirm').onclick = async function() {
                showLoading();

                try {
                    const formData = new FormData();
                    const resp = await fetch(`${API_BASE}/delete_db`, {
                        method: 'POST',
                        body: formData
                    });
                    hideLoading();
                    document.getElementById('delete-db-modal').style.display = 'none';
                    document.getElementById('scrape-settings-modal').style.display = 'none';
                    if (resp.ok) {
                        showAlert('success', 'Baza de date a fost ștearsă!');
                        loadProducts();
                    } else {
                        showAlert('error', 'Eroare la ștergerea bazei de date!');
                    }
                    loadProducts()
                } catch (e) {
                    hideLoading();
                    document.getElementById('delete-db-modal').style.display = 'none';
                    showAlert('error', 'Eroare la ștergerea bazei de date!');
                }
            };
            document.getElementById('site-config-btn').onclick = function() {
                document.getElementById('site-config-modal').style.display = 'block';
                window._selectedSiteIdx = null; // Resetează selecția la deschidere
                renderSiteList();
                document.getElementById('site-properties').style.display = 'none';
                document.getElementById('site-config-save').style.display = 'none';
            };
            document.getElementById('site-config-close').onclick = function() {
                document.getElementById('site-config-modal').style.display = 'none';
                let deleteBtn = document.getElementById('delete-site-btn');
                if (deleteBtn) deleteBtn.style.display = 'none';
                window._selectedSiteIdx = null;
                renderSiteList();
            };
            document.getElementById('site-config-cancel').onclick = function() {
                document.getElementById('site-config-modal').style.display = 'none';
                let deleteBtn = document.getElementById('delete-site-btn');
                if (deleteBtn) deleteBtn.style.display = 'none';
                window._selectedSiteIdx = null;
                renderSiteList();
            };
        }

        async function loadProducts() {
            showLoading();
            try {
                let params = new URLSearchParams({
                    q: currentFilters.q || '',
                    site: currentFilters.site || '',
                    page: currentPage,
                    per_page: currentFilters.per_page,
                    order_by: lastOrderBy,
                    reversed: reversed
                });
                let resp = await fetch(`/products?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) throw new Error('Eroare la încărcarea produselor');
                let data = await resp.json();
                renderProducts(data);
            } catch (error) {
                showAlert('error', error.message);
                document.getElementById('products-table').innerHTML = `<tr><td colspan="7" class="empty-state"><i class="fas fa-exclamation-triangle"></i><div>Eroare la încărcarea datelor</div></td></tr>`;
            } finally {
                hideLoading();
            }
        }

        function renderProducts(data) {
            const tbody = document.getElementById('products-table');
            tbody.innerHTML = '';
            if (!data.items || data.items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><i class="fas fa-box-open"></i><div>Nu au fost găsite produse</div></td></tr>`;
            } else {
                //${idx + 1 + (data.page-1)*data.per_page}
                data.items.forEach((p, idx) => {
                    tbody.innerHTML += `<tr>
                        <td><input type="checkbox" class="checkbox product-checkbox" value="${p.id}" onchange="toggleProductSelection(${p.id})"></td>
                        <td>${p.id}</td>
                        <td><span class="site-badge">${p.site_name}</span></td>
                        <td><a href="/product/${p.id}" class="product-link">${p.title}</a></td>
                        <td class="price">${p.currency || ''} ${p.last_price !== null ? p.last_price : '-'}</td>
                        <td>${p.rating !== null ? p.rating : '-'}${p.ratings_count ? ` (${p.ratings_count})` : ''}</td>
                        <td class="text-muted">${p.last_seen_at}</td>
                    </tr>`;
                });
            }
            updateSelectAllCheckbox();
            updateBulkActions();
            renderPagination(data.page, data.total, data.per_page);
            document.getElementById('total-products').textContent = data.total;
        }

        function renderPagination(page, total, per_page) {
            const pag = document.querySelector('.pagination');
            pag.innerHTML = '';
            const totalPages = Math.max(1, Math.ceil(total / per_page));
            if (totalPages <= 1) return;
            pag.innerHTML += `<button class="page-btn${page === 1 ? ' disabled' : ''}" onclick="changePage(-1)" ${page === 1 ? 'disabled' : ''}>&laquo; Prev</button>`;
            pag.innerHTML += `<span class="page-info">${page} / ${totalPages}</span>`;
            pag.innerHTML += `<button class="page-btn${page === totalPages ? ' disabled' : ''}" onclick="changePage(1)" ${page === totalPages ? 'disabled' : ''}>Next &raquo;</button>`;
        }

        function changePage(direction) {
            const total = parseInt(document.getElementById('total-products').textContent);
            const totalPages = Math.max(1, Math.ceil(total / currentFilters.per_page));
            let newPage = currentPage + direction;
            if (newPage < 1 || newPage > totalPages) return;
            currentPage = newPage;
            loadProducts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const productId = parseInt(checkbox.value);
                if (selectAll.checked) selectedProducts.add(productId);
                else selectedProducts.delete(productId);
            });
            updateBulkActions();
        }

        function toggleProductSelection(productId) {
            productId = parseInt(productId);
            if (selectedProducts.has(productId)) selectedProducts.delete(productId);
            else selectedProducts.add(productId);
            updateSelectAllCheckbox();
            updateBulkActions();
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
            if (checkedBoxes.length === 0) { selectAll.checked = false; selectAll.indeterminate = false; }
            else if (checkedBoxes.length === productCheckboxes.length) { selectAll.checked = true; selectAll.indeterminate = false; }
            else { selectAll.checked = false; selectAll.indeterminate = true; }
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulk-actions');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const selectedCount = document.getElementById('selected-count');
            selectedCount.textContent = selectedProducts.size;
            bulkDeleteBtn.disabled = selectedProducts.size === 0;
            if (selectedProducts.size > 0) bulkActions.classList.add('active');
            else bulkActions.classList.remove('active');
        }

        function handleFilter(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            currentFilters.q = formData.get('q') || '';
            currentFilters.site = formData.get('site') || '';
            currentFilters.per_page = parseInt(formData.get('per_page')) || 25;
            currentPage = 1;
            selectedProducts.clear();
            loadProducts();
        }

        async function handleBulkDelete(event) {
            event.preventDefault();
            if (selectedProducts.size === 0) return;
            // Setează textul corect pentru singular/plural
            const count = selectedProducts.size;
            const isSingular = count === 1;
            document.getElementById('bulk-delete-modal-title').textContent = isSingular ? 'Ștergere produs selectat' : 'Ștergere produse selectate';
            document.getElementById('bulk-delete-modal-msg').innerHTML =
                `Sigur vrei să ștergi <b>${count} ${isSingular ? 'produs' : 'produse'}</b> selectat${isSingular ? '' : 'e'}?<br><b>Această acțiune este ireversibilă!</b>`;
            document.getElementById('bulk-delete-modal').style.display = 'block';
        }

        // Confirmare/Anulare bulk delete
        document.getElementById('bulk-delete-confirm').onclick = async function() {
            document.getElementById('bulk-delete-modal').style.display = 'none';
            showLoading();
            try {
                let formData = new FormData();
                selectedProducts.forEach(id => formData.append('product_ids', id));
                let resp = await fetch('/bulk_delete', { method: 'POST', body: formData });
                const data = await resp.json();
                const count = selectedProducts.size;
                const isSingular = count === 1;
                if (data.ok) {
                    showAlert('success', `${count} ${isSingular ? 'produs a fost șters cu succes' : 'produse au fost șterse cu succes'}`);
                    selectedProducts.clear();
                    loadProducts();
                }
                else {
                    showAlert('error', data.error || 'Eroare la ștergere');
                }
            } catch (error) {
                showAlert('error', 'Eroare la ștergerea produselor: ' + error.message);
            } finally { hideLoading(); }
        };
        document.getElementById('bulk-delete-cancel').onclick = function() {
            document.getElementById('bulk-delete-modal').style.display = 'none';
        };
        document.getElementById('bulk-delete-close').onclick = function() {
            document.getElementById('bulk-delete-modal').style.display = 'none';
        };

        async function exportData(format) {
            // Închide dropdown-ul
            document.querySelector('.export-dropdown').classList.remove('open');
            showLoading();
            try {
                let params = new URLSearchParams({ q: currentFilters.q || '', site: currentFilters.site || '' });
                if (format === 'csv') {
                    window.location.href = `/export.csv?${params.toString()}`;
                } else if (format === 'pdf') {
                    window.location.href = `/export.pdf?${params.toString()}`;
                } else if (format === 'xlsx') {
                    window.location.href = `/export.xlsx?${params.toString()}`;
                }
            } catch (error) {
                showAlert('error', 'Eroare la export: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showLoading() { document.getElementById('loading').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }
        function showAlert(type, message) {
            hideLoading();
            // Pentru eroare la panelul de configurare site, afișează un toast central
            if (type === 'error' && document.getElementById('site-config-modal').style.display === 'block') {
                let toast = document.getElementById('site-config-error-toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'site-config-error-toast';
                    toast.style.position = 'fixed';
                    toast.style.top = '50%';
                    toast.style.left = '50%';
                    toast.style.transform = 'translate(-50%, -50%)';
                    toast.style.background = 'rgba(239,68,68,0.98)';
                    toast.style.color = 'white';
                    toast.style.padding = '1.2em 2em';
                    toast.style.borderRadius = '12px';
                    toast.style.fontSize = '1.2em';
                    toast.style.zIndex = '9999';
                    toast.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18)';
                    toast.style.textAlign = 'center';
                    toast.style.maxWidth = '90vw';
                    toast.style.pointerEvents = 'none';
                    document.body.appendChild(toast);
                }
                toast.textContent = message;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3500);
                return;
            }
            // ...existing code for success/error alerts...
            if (type === 'success') {
                if(scrapingInProgress)
                    return;
                document.getElementById('alert-success').style.display = 'flex';
                document.getElementById('success-message').textContent = message;
                setTimeout(() => { if(!scrapingInProgress)  {
                    document.getElementById('alert-success').style.display = 'none';
                } }, 3000);
            } else {
                document.getElementById('alert-error').style.display = 'flex';
                document.getElementById('error-message').textContent = message;
                setTimeout(() => { document.getElementById('alert-error').style.display = 'none'; }, 4000);
            }
        }

        function debounce(fn, delay) {
            let timer; return function(...args) { clearTimeout(timer); timer = setTimeout(() => fn.apply(this, args), delay); };
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') document.getElementById('filter-title').focus();
            if (e.ctrlKey && e.key === 's') document.querySelector('.scrape-input').focus();
            //if (e.ctrlKey && e.key === 'a') { document.getElementById('select-all').checked = true; toggleSelectAll(); }
            if (e.key === 'Delete') { if (selectedProducts.size > 0) document.getElementById('bulk-delete-btn').click(); }
        });

        function updateURL() {
            const params = new URLSearchParams();
            if (currentFilters.q) params.set('q', currentFilters.q);
            if (currentFilters.site) params.set('site', currentFilters.site);
            // Adaugă per_page doar dacă este diferit de 25
            if (currentFilters.per_page !== 25 && currentFilters.per_page !== '25') params.set('per_page', currentFilters.per_page);
            if (currentPage !== 1) params.set('page', currentPage);
            const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            window.history.replaceState(null, '', newURL);
        }

        function initializeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            currentFilters.q = urlParams.get('q') || '';
            currentFilters.site = urlParams.get('site') || '';
            let perPage = urlParams.get('per_page') || '25';
            // Permite doar valorile 10, 25, 50
            if (!['10', '25', '50'].includes(perPage)) perPage = '25';
            currentFilters.per_page = perPage;
            currentPage = parseInt(urlParams.get('page')) || 1;
            const total = parseInt(document.getElementById('total-products').textContent);
            let totalPages;
            if(currentPage == 0)
                totalPages = -1;
            else
                totalPages = Math.max(1, Math.ceil(total / currentFilters.per_page));
            if(currentPage > totalPages || currentPage < 1)
                currentPage = 1;
            document.getElementById('filter-title').value = currentFilters.q;
            document.getElementById('filter-site').value = currentFilters.site;
            // Setează explicit valoarea selectată în dropdown
            const perPageSelect = document.getElementById('per-page');
            perPageSelect.value = per_page;
            // Dacă valoarea nu există ca <option>, selectează implicit 25
            if (!Array.from(perPageSelect.options).some(opt => opt.value === perPage)) {
                perPageSelect.value = '25';
                currentFilters.per_page = '25';
            }
        }

        async function handleScrape(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const query = formData.get('query');
            
            if (!query || !query.trim()) {
                showAlert('error', 'Te rog introdu un termen de căutare');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/scrape/trigger?query=${query}`,
                                                        { method: 'POST', body: formData });
                
                if (response.ok) {
                    const alertElement = document.getElementById(`alert-success`);
                    const messageElement = document.getElementById(`success-message`);
                    
                    messageElement.textContent = 'Scraping in progres cu query =  ' + query;
                    alertElement.style.display = 'flex';

                    // Dezactivează butonul și afișează mesajul "Scraping in progress..."
                    const scrapeBtn = document.querySelector('#scrape-form button[type="submit"]');
                    scrapeBtn.disabled = true;
                    scrapeBtn.classList.add('btn-danger'); // adaugă stil vizibil pentru dezactivat
                    scrapeBtn.classList.remove('btn-primary');

                    hideLoading();
                    
                    // Polling status
                    scrapingInProgress = true;
                    let finished = false;
                    let nr_products = ''
                    while (!finished) {
                        await new Promise(res => setTimeout(res, 2000));
                        let statusResp = await fetch(`${API_BASE}/scrape/status`, { method: 'GET' });
                        let statusData = await statusResp.json();
                        if (statusData.status === 'done') {
                            finished = true;
                            nr_products = statusData.len_products;
                        }
                    }
                    scrapingInProgress = false;
                    showAlert('success', 'Scraping finalizat! Au fost afectate ' + nr_products + ' produse');
                    showLoading();
                    loadProducts();
                    hideLoading();
                    scrapeBtn.disabled = false;
                    scrapeBtn.classList.remove('btn-danger');
                    scrapeBtn.classList.add('btn-primary');
                    const scrapeInput = document.getElementById('scrape-query');
                    scrapeInput.value = ""; // elimină textul din input
                } else {
                    throw new Error('Eroare la pornirea scraping-ului');
                }
                
            } catch (error) {
                console.error('Scrape error:', error);
                showAlert('error', 'Eroare la pornirea scraping-ului: ' + error.message);
            } finally {
                
            }
        }

        function handleFilter(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            currentFilters = {
                q: formData.get('q') || '',
                site: formData.get('site') || '',
                per_page: formData.get('per_page') || '25'
            };
            
            currentPage = 1; // Reset to first page
            selectedProducts.clear();
            loadProducts();
        }

        /* async function handleBulkDelete(event) {
            console.log("20\n")
            event.preventDefault();
            
            if (selectedProducts.size === 0) return;
            
            const confirmed = confirm(`Sigur vrei să ștergi ${selectedProducts.size} produse selectate?`);
            if (!confirmed) return;
            
            showLoading();
            
            try {
                let formData = new FormData();
                selectedProducts.forEach(id => {
                    formData.append('product_ids', id);
                });
                
                const response = await fetch(`${API_BASE}/bulk_delete_products`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('success', `${selectedProducts.size} produse au fost șterse cu succes`);
                    selectedProducts.clear();
                    loadProducts();
                } else {
                    throw new Error('Eroare la ștergerea produselor');
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('error', 'Eroare la ștergerea produselor: ' + error.message);
            } finally {
                hideLoading();
            }
        } */

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1) {
                currentPage = newPage;
                selectedProducts.clear();
                loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const productId = parseInt(checkbox.value);
                
                if (selectAll.checked) {
                    selectedProducts.add(productId);
                } else {
                    selectedProducts.delete(productId);
                }
            });
            
            updateBulkActions();
        }

        function toggleProductSelection(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }
            
            updateSelectAllCheckbox();
            updateBulkActions();
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedBoxes.length === productCheckboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulk-actions');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const selectedCount = document.getElementById('selected-count');
            
            selectedCount.textContent = selectedProducts.size;
            bulkDeleteBtn.disabled = selectedProducts.size === 0;
            
            if (selectedProducts.size > 0) {
                bulkActions.classList.add('active');
            } else {
                bulkActions.classList.remove('active');
            }
        }

        function viewProduct(productId) {
            // Navigate to product detail page
            window.location.href = `${API_BASE}/product/${productId}`;
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        /* function showAlert(type, message) {
            const alertElement = document.getElementById(`alert-${type}`);
            const messageElement = document.getElementById(`${type}-message`);
            
            messageElement.textContent = message;
            alertElement.style.display = 'flex';
            
            setTimeout(() => {
                if(!scrapingInProgress)
                    alertElement.style.display = 'none';
            }, 5000);
        } */

        function HandleHeaderBtn(orderBy) {
            if(lastOrderBy == orderBy)
                reversed = !reversed;
            else
                reversed = true;

            lastOrderBy = orderBy;

            loadProducts();
        }

        // Auto-refresh every 30 seconds to check for new data
        /* setInterval(() => {
            loadProducts();
        }, 30000); */

        console.log('🚀 Price Tracker connected to API successfully!');
        console.log('📡 API Base URL:', API_BASE);
        console.log('🔄 Auto-refresh enabled every 30 seconds');
        console.log('💡 Keyboard shortcuts available:');
        console.log('   Ctrl+F: Focus search');
        console.log('   Ctrl+S: Focus scrape input');
        console.log('   Ctrl+A: Select all');
        console.log('   Delete: Bulk delete selected');

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'f':
                        e.preventDefault();
                        document.getElementById('filter-title').focus();
                        break;
                    case 's':
                        e.preventDefault();
                        document.getElementById('scrape-query').focus();
                        break;
                }
            }
            
            // Delete key for bulk delete
            /* if (e.key === 'Delete' && selectedProducts.size > 0) {
                document.getElementById('bulk-delete-btn').click();
            } */
        });

        // Enhanced search with debouncing
        let searchTimeout;
        document.getElementById('filter-title').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                document.getElementById('filter-form').dispatchEvent(new Event('submit'));
            }, 500);
        });

        document.getElementById('filter-site').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                document.getElementById('filter-form').dispatchEvent(new Event('submit'));
            }, 500);
        });

        // URL state management
        function updateURL() {
            const params = new URLSearchParams();
            if (currentFilters.q) params.set('q', currentFilters.q);
            if (currentFilters.site) params.set('site', currentFilters.site);
            // Adaugă per_page doar dacă este diferit de 25
            //if (currentFilters.per_page !== 25 && currentFilters.per_page !== '25') params.set('per_page', currentFilters.per_page);
            if (currentPage !== 1) params.set('page', currentPage);
            
            const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            window.history.replaceState(null, '', newURL);
        }

        // Initialize filters from URL
        function initializeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            
            currentFilters.q = urlParams.get('q') || '';
            currentFilters.site = urlParams.get('site') || '';
            currentFilters.per_page = urlParams.get('per_page') || '25';
            currentPage = parseInt(urlParams.get('page')) || 1;
            const total = parseInt(document.getElementById('total-products').textContent);
            let totalPages;
            if(currentPage == 0)
                totalPages = -1;
            else
                totalPages = Math.max(1, Math.ceil(total / currentFilters.per_page));
            if(currentPage > totalPages || currentPage < 1)
                currentPage = 1;
            
            // Update form fields
            document.getElementById('filter-title').value = currentFilters.q;
            document.getElementById('filter-site').value = currentFilters.site;
            //document.getElementById('per-page').value = currentFilters.per_page;
        }

        // Call on page load
        initializeFromURL();

        // Update URL when filters change
        const originalLoadProducts = loadProducts;
        loadProducts = function() {
            updateURL();
            return originalLoadProducts();
        };

        // Sort header arrow logic (independent, nu modifică funcțiile tale)
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            let sortState = { col: null, dir: null };

            function resetHeaderButtons() {
                document.querySelectorAll('.table-header-btn').forEach(btn => {
                    btn.classList.remove('active');
                    let arrow = btn.querySelector('.table-header-arrow');
                    if (arrow) arrow.remove();
                });
            }

            function setHeaderArrow(btn, dir) {
                resetHeaderButtons();
                btn.classList.add('active');
                // Remove any arrow first
                let arrow = btn.querySelector('.table-header-arrow');
                if (arrow) arrow.remove();
                // Insert arrow before header-text
                let headerText = btn.querySelector('.header-text');
                let arrowEl = document.createElement('span');
                arrowEl.className = 'table-header-arrow';
                arrowEl.innerHTML = dir === 'asc' ? '&#8593;' : '&#8595;';
                btn.insertBefore(arrowEl, headerText);
            }

            document.querySelectorAll('.table-header-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const col = btn.getAttribute('data-col');
                    if (sortState.col === col) {
                        sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.col = col;
                        sortState.dir = 'asc';
                    }
                    resetHeaderButtons();
                    setHeaderArrow(btn, sortState.dir);
                });
            });
        });

        // Dropdown logic
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('export-btn');
            const exportDropdown = document.querySelector('.export-dropdown');
            const dropdownMenu = document.getElementById('export-dropdown-menu');

            exportBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                exportDropdown.classList.toggle('open');
            });

            // Fix: dropdown should close only if click is outside BOTH button and menu
            document.addEventListener('click', function(e) {
                if (!exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('open');
                }
            });

            // Prevent dropdown from closing when clicking inside the menu
            dropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Exemplu config pentru site-uri (poate fi încărcat din backend)
        let sitesConfig = [
            {
              "name": "",
              "url": "",
              "url_searchTemplate": "",
              "selectors": {
                "product": "",
                "title": "",
                "link": "",
                "price": "",
                "currency": "",
                "rating": "",
                "id": "",
                "image_link": "",
                "remove_items_with": "",
                "end_of_pages": ""
              }
            }
        ];

        // Deschide panelul de configurare site
        document.getElementById('site-config-btn').onclick = function() {
            document.getElementById('site-config-modal').style.display = 'block';
            window._selectedSiteIdx = null; // Resetează selecția la deschidere
            renderSiteList();
            document.getElementById('site-properties').style.display = 'none';
            document.getElementById('site-config-save').style.display = 'none';
        };

        // Închide panelul
        document.getElementById('site-config-close').onclick = function() {
            document.getElementById('site-config-modal').style.display = 'none';
            let deleteBtn = document.getElementById('delete-site-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            window._selectedSiteIdx = null;
            renderSiteList();
        };
        document.getElementById('site-config-cancel').onclick = function() {
            document.getElementById('site-config-modal').style.display = 'none';
            let deleteBtn = document.getElementById('delete-site-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            window._selectedSiteIdx = null;
            renderSiteList();
        };

        async function renderSiteList() {
            const siteListDiv = document.getElementById('site-list');
            siteListDiv.innerHTML = '';
            let selectedIdx = window._selectedSiteIdx === null ? null : window._selectedSiteIdx;

            let requestResp = await fetch(`${API_BASE}/get_site_number`, { method: 'GET' });
            let data = await requestResp.json();

            for (let idx = 0; idx < data.nr_sites; idx++) {
                const site = sitesConfig[idx];
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-secondary';
                btn.style = 'margin-bottom:0.5rem; margin-right:0.5rem;';
                let requestResp_Site = await fetch(`${API_BASE}/get_site_settings?index=${idx}`, { method: 'GET' });
                let data_Site = await requestResp_Site.json();
                btn.textContent = data_Site.name;
                btn.onclick = async function() {
                    window._selectedSiteIdx = idx;
                    await renderSiteList();
                    await renderSiteProperties(idx);
                };
                if (selectedIdx !== null && selectedIdx === idx) {
                    btn.style.background = '#e2e8f0';
                    btn.style.color = 'var(--primary)';
                    btn.style.border = '2px solid var(--primary)';
                    btn.style.fontWeight = 'bold';
                    btn.style.boxShadow = 'none';
                    btn.style.transform = 'none';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.border = '';
                    btn.style.fontWeight = '';
                    btn.style.boxShadow = '';
                    btn.style.transform = '';
                }
                siteListDiv.appendChild(btn);
            }

            // Buton plus pentru adăugare site nou
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-primary';
            addBtn.style = 'margin-bottom:0.5rem; margin-right:0.5rem; display:flex; align-items:center; gap:0.3rem;';
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Adaugă site';
            addBtn.onclick = function() {
                // Găsește toate numele de tip "Nume nou site" sau "Nume nou site (nr)"
                const baseName = 'Nume nou site';
                const usedNumbers = new Set();
                sitesConfig.forEach(site => {
                    if (site.name === baseName) {
                        usedNumbers.add(0);
                    } else {
                        const match = site.name.match(/^Nume nou site \((\d+)\)$/);
                        if (match) {
                            usedNumbers.add(parseInt(match[1], 10));
                        }
                    }
                });
                // Găsește cel mai mic număr liber
                let newName = baseName;
                if (usedNumbers.has(0)) {
                    let nr = 1;
                    while (usedNumbers.has(nr)) nr++;
                    newName = `${baseName} (${nr})`;
                }
                const newSite = {
                    name: newName,
                    url: '',
                    url_searchTemplate: '',
                    selectors: {
                        product: '',
                        title: '',
                        link: '',
                        price: '',
                        currency: '',
                        rating: '',
                        id: '',
                        remove_items_with: '',
                        end_of_pages: ''
                    }
                };
                sitesConfig.push(newSite);
                window._selectedSiteIdx = 0;
                renderSiteList();
                renderSiteProperties(0);
            };
            siteListDiv.appendChild(addBtn);

            // Asigură-te că acțiunile sunt la dreapta când nu e editare
            const actionsRow = document.getElementById('site-actions-row');
            if (actionsRow) {
                // Ascunde butonul de salvare
                //document.getElementById('site-config-save').style.display = 'none';
                actionsRow.style.justifyContent = 'flex-end';
            }
        }

        // Render inputuri pentru proprietăți site
        async function renderSiteProperties(siteIdx) {
            window._selectedSiteIdx = siteIdx;
            let site = sitesConfig[0];

            let requestResp = await fetch(`${API_BASE}/get_site_settings?index=${siteIdx}`, { method: 'GET' });
            let data = await requestResp.json();
            site.selectors.product = data.product;
            site.selectors.title = data.title;
            site.selectors.link = data.link;
            site.selectors.price = data.price;
            site.selectors.currency = data.currency;
            site.selectors.rating = data.rating;
            site.selectors.id = data.id;
            site.selectors.image_link = data.image_link;
            site.selectors.remove_items_with = data.remove_items_with;
            site.selectors.end_of_pages = data.end_of_pages;

            const formDiv = document.getElementById('site-properties');
            const form = document.getElementById('site-properties-form');
            formDiv.style.display = 'block';
            document.getElementById('site-config-save').style.display = 'inline-block';
            document.getElementById('site-actions-row').style.justifyContent = 'space-between';

            form.innerHTML = `
                <label style="display:flex;align-items:center;gap:0.7em;">
                    Nume site:
                    <span id="site-name-error" style="color:#ef4444;font-size:1em;font-weight:500;display:none;margin-left:0.5em;"></span>
                </label>
                <input type="text" name="site_name" id="site-name-input" class="form-input" value="${data.name}" style="width:100%;margin-bottom:1rem;">
                <label>URL:</label>
                <input type="text" name="url" class="form-input" value="${data.url}" style="width:100%;margin-bottom:1rem;">
                <label>URL Search Template:</label>
                <input type="text" name="url_searchTemplate" class="form-input" value="${data.url_searchTemplate}" style="width:100%;margin-bottom:1rem;">
                ${Object.entries(site.selectors).map(([key, val]) => `
                    <label>${key}:</label>
                    <input type="text" name="selector_${key}" class="form-input" value="${val}" style="width:100%;margin-bottom:0.7rem;">
                `).join('')}
            `;

            const deleteBtn = document.getElementById('delete-site-btn');
            deleteBtn.style.display = 'flex';

            document.getElementById('site-config-save').onclick = function() {
                const nameInput = document.getElementById('site-name-input');
                const errorSpan = document.getElementById('site-name-error');
                const newName = nameInput.value.trim();

                // Găsește toate numele de tip "Nume nou site" sau "Nume nou site (nr)"
                const baseName = 'Nume nou site';
                const usedNumbers = new Set();
                sitesConfig.forEach((s, idx2) => {
                    if (idx2 !== siteIdx) {
                        if (s.name === baseName) {
                           
                            usedNumbers.add(0);
                        } else if (s.name.startsWith(baseName + " (")) {
                            const match = s.name.match(/^Nume nou site \((\d+)\)$/);
                            if (match) {
                                usedNumbers.add(parseInt(match[1], 10));
                            }
                        }
                    }
                });

                // Resetare stiluri eroare
                errorSpan.style.display = 'none';
                nameInput.style.border = '';
                nameInput.style.boxShadow = '';

                // Verifică unicitatea numelui
                const duplicate = sitesConfig.some((s, idx2) => idx2 !== siteIdx && s.name.trim().toLowerCase() === newName.toLowerCase());
                if (!newName) {
                    errorSpan.textContent = 'Numele site-ului nu poate fi gol!';
                    errorSpan.style.display = 'inline';
                    nameInput.style.border = '2px solid #ef4444';
                    nameInput.style.boxShadow = '0 0 0 2px #ef444433';
                    nameInput.focus();
                    nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                if (duplicate) {
                    errorSpan.textContent = 'Există deja un site cu acest nume!';
                    errorSpan.style.display = 'inline';
                    nameInput.style.border = '2px solid #ef4444';
                    nameInput.style.boxShadow = '0 0 0 2px #ef444433';

                    nameInput.focus();
                    nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                // Dacă numele vechi era de tip "Nume nou site (nr)" și îl modifici, eliberează acel număr
                if (site.name.startsWith(baseName + " (")) {
                    const match = site.name.match(/^Nume nou site \((\d+)\)$/);
                    if (match) {
                        usedNumbers.delete(parseInt(match[1], 10));
                    }
                } else if (site.name === baseName) {
                    usedNumbers.delete(0);
                }

                site.name = newName;
                site.url = form.url.value;
                site.url_searchTemplate = form.url_searchTemplate.value;
                Object.keys(site.selectors).forEach(key => {
                    site.selectors[key] = form[`selector_${key}`].value;
                });
                document.getElementById('site-config-modal').style.display = 'none';
                deleteBtn.style.display = 'none';
                window._selectedSiteIdx = null;
                showAlert('success', `Configurația pentru ${site.name} a fost salvată!`);
                renderSiteList();
            };

            // Șterge site-ul cu panel de confirmare
            deleteBtn.onclick = function() {
                // Setează mesajul cu numele site-ului
                document.getElementById('delete-site-modal-msg').innerHTML =
                    `Sigur vrei să ștergi site-ul <b>${site.name}</b>?<br><b>Această acțiune este ireversibilă!</b>`;
                document.getElementById('delete-site-modal').style.display = 'block';

                // Confirmare
                document.getElementById('delete-site-confirm').onclick = function() {
                    sitesConfig.splice(siteIdx, 1);
                    renderSiteList();
                    document.getElementById('site-properties').style.display = 'none';
                    document.getElementById('site-config-save').style.display = 'none';
                    deleteBtn.style.display = 'none';
                    document.getElementById('delete-site-modal').style.display = 'none';
                    showAlert('success', `Site-ul "${site.name}" a fost șters!`);
                };
                // Anulează
                document.getElementById('delete-site-cancel').onclick = function() {
                    document.getElementById('delete-site-modal').style.display = 'none';
                };
                document.getElementById('delete-site-close').onclick = function() {
                    document.getElementById('delete-site-modal').style.display = 'none';
                };
            };
        }

        document.getElementById('site-config-close').onclick = function() {
            document.getElementById('site-config-modal').style.display = 'none';
            let deleteBtn = document.getElementById('delete-site-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            window._selectedSiteIdx = null;
            renderSiteList();
        };
        document.getElementById('site-config-cancel').onclick = function() {
            document.getElementById('site-config-modal').style.display = 'none';
            let deleteBtn = document.getElementById('delete-site-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            window._selectedSiteIdx = null;
            renderSiteList();
        };
    </script>
</body>
</html>